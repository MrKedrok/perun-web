<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Analityczny Orlego Kierowcy - Perun AI</title>
    <meta name="description" content="Zobacz swoje postƒôpy na torze z Perun AI! Analiza historyczna i bie≈ºƒÖca, wykresy i wskaz√≥wki od Twojego Bielika Trenera, teraz z mocƒÖ Gemini API!">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            scroll-behavior: smooth;
            background-color: #E0F2FE; /* Bardzo jasny b≈Çƒôkit, jak niebo */
            color: #1F2937; 
        }
        .font-fredoka {
            font-family: 'Fredoka One', cursive;
        }
        
        .bielik-red { color: #EF4444; } 
        .bielik-red-bg { background-color: #EF4444; }
        .bielik-red-bg-hover:hover { background-color: #DC2626; }

        .bielik-blue { color: #3B82F6; } 
        .bielik-blue-bg { background-color: #3B82F6; }
        .bielik-blue-bg-hover:hover { background-color: #2563EB; }

        .bielik-yellow { color: #F59E0B; } 
        .bielik-yellow-bg { background-color: #F59E0B; }

        .bielik-green { color: #10B981; }
        .bielik-green-bg { background-color: #10B981; }
        
        .dashboard-card {
            background: white;
            border: 3px solid #1F2937; 
            box-shadow: 6px 6px 0px #9CA3AF; /* Szary cie≈Ñ dla kart dashboardu */
            transition: all 0.2s ease-out;
            border-radius: 16px;
        }
        .dashboard-card:hover {
            transform: translate(-4px, -4px);
            box-shadow: 10px 10px 0px #3B82F6; /* Niebieski cie≈Ñ przy hover */
        }
        .button-cartoon { 
            border: 3px solid #1F2937;
            box-shadow: 4px 4px 0px #1F2937;
            transition: all 0.15s ease-out !important;
            font-weight: 800; 
            border-radius: 8px;
            cursor: pointer;
        }
        .button-cartoon:hover {
            transform: translate(-2px, -2px) !important;
            box-shadow: 6px 6px 0px #1F2937 !important;
            background-color: #F59E0B;
            color: #1F2937;
        }
        .button-cartoon:active {
            transform: translate(2px, 2px) !important;
            box-shadow: 2px 2px 0px #1F2937 !important;
        }
        .button-gemini { /* Specjalny styl dla przycisk√≥w Gemini */
            background-color: #F59E0B; /* ≈ª√≥≈Çty */
            color: #1F2937;
        }
        .button-gemini:hover {
            background-color: #EF4444; /* Czerwony przy hover */
            color: white;
        }
        .section-title-dashboard {
            text-shadow: 2px 2px 0px #A5F3FC, 4px 4px 0px #67E8F9; /* Jasnoniebieski cie≈Ñ */
        }
        .llm-comment-card {
            background-color: #FFFAE5; 
            border: 2px dashed #F59E0B; 
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
            position: relative;
        }
        .llm-comment-card::before { 
            content: "";
            position: absolute;
            bottom: 100%;
            left: 30px;
            border-width: 10px;
            border-style: solid;
            border-color: transparent transparent #F59E0B transparent;
        }
        .llm-comment-card strong {
            color: #D97706; 
        }
        .gemini-response-card { /* Styl dla odpowiedzi od Gemini */
            background-color: #E0FEFE; /* Jasno-turkusowe t≈Ço */
            border: 2px dashed #00E6E6; 
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
            position: relative;
        }
        .gemini-response-card::before {
            content: "‚ú®";
            position: absolute;
            top: -15px;
            left: 10px;
            font-size: 1.8rem;
            transform: rotate(-15deg);
        }
        .gemini-response-card strong {
            color: #008080; /* Ciemniejszy turkus */
        }
        .chart-container {
            padding: 1.5rem;
            border-radius: 12px;
            background-color: #FFFFFF;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 1rem; /* Zmniejszony margines */
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3B82F6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased">

    <header class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center">
                <img src="https://placehold.co/60x60/3B82F6/FFFFFF?text=ü¶Ö" alt="Logo Perun AI - Kresk√≥wkowy Bielik" class="h-10 w-10 sm:h-12 sm:w-12 mr-3 rounded-full">
                <h1 class="text-2xl sm:text-3xl font-fredoka bielik-blue">
                    PERUN<span class="bielik-red">.AI</span> <span class="text-lg sm:text-xl text-gray-600 font-nunito">- Panel Orlego Kierowcy</span>
                </h1>
            </div>
            <span class="font-semibold text-gray-700 text-sm sm:text-base">Witaj, Wojtek Orli≈Ñski!</span>
        </div>
    </header>

    <main class="container mx-auto px-4 sm:px-6 py-8">

        <section id="summary" class="mb-12">
            <h2 class="text-3xl sm:text-4xl font-fredoka text-center mb-8 text-gray-800 section-title-dashboard">Tw√≥j Orli PrzeglƒÖd OsiƒÖgniƒôƒá! üìä</h2>
            <div class="grid md:grid-cols-3 gap-6 mb-6">
                <div class="dashboard-card p-6 text-center">
                    <img src="https://placehold.co/80x80/FEF3C7/F59E0B?text=üèÜ" alt="Puchar za najlepszy czas" class="mx-auto mb-3 h-16 w-16">
                    <h3 class="text-xl font-fredoka text-gray-700 mb-1">Najlepszy Czas OkrƒÖ≈ºenia</h3>
                    <p class="text-3xl font-bold bielik-red" id="bestLapTime">1:02.345</p>
                    <p class="text-sm text-gray-500">(Sesja z 20.05.2025)</p>
                </div>
                <div class="dashboard-card p-6 text-center">
                    <img src="https://placehold.co/80x80/DBEAFE/3B82F6?text=üèéÔ∏èüí®" alt="Gokart w ruchu" class="mx-auto mb-3 h-16 w-16">
                    <h3 class="text-xl font-fredoka text-gray-700 mb-1">≈ÅƒÖczna Liczba Przejazd√≥w</h3>
                    <p class="text-3xl font-bold bielik-blue">128</p>
                    <p class="text-sm text-gray-500">Od poczƒÖtku przygody!</p>
                </div>
                <div class="dashboard-card p-6 text-center">
                     <img src="https://placehold.co/80x80/D1FAE5/10B981?text=üìÖ" alt="Kalendarz z ostatniƒÖ sesjƒÖ" class="mx-auto mb-3 h-16 w-16">
                    <h3 class="text-xl font-fredoka text-gray-700 mb-1">Ostatnia Sesja</h3>
                    <p class="text-2xl font-bold bielik-green" id="lastSessionTime">1:03.112</p>
                    <p class="text-sm text-gray-500">(21.05.2025 - Tor KartPlanet)</p>
                </div>
            </div>
            <div class="llm-comment-card">
                <p class="text-gray-700"><strong class="font-fredoka">Bielik M√≥wi:</strong> Hej, <strong id="userName">Wojtek Orli≈Ñski</strong>! Tw√≥j Orli Panel jest gotowy do startu! Zobaczmy, jak dzisiaj szybowa≈Çe≈õ po torze! Pamiƒôtaj, ka≈ºdy lot, nawet ten z ma≈Çym potkniƒôciem o krawƒô≈ºnik, to krok do mistrzostwa i super zabawy! Jestem tu, by pom√≥c Ci rozwinƒÖƒá skrzyd≈Ça! ü¶Öüí®</p>
            </div>
        </section>

        <section id="progress" class="mb-12">
            <h2 class="text-3xl sm:text-4xl font-fredoka text-center mb-8 text-gray-800 section-title-dashboard">Tw√≥j Lot ku Mistrzostwu! üìà</h2>
            <div class="grid lg:grid-cols-2 gap-8">
                <div class="chart-container">
                    <h3 class="text-xl font-fredoka text-center mb-4 text-gray-700">Ewolucja Czasu OkrƒÖ≈ºenia (Ostatnie 10 Sesji)</h3>
                    <canvas id="lapTimeEvolutionChart"></canvas>
                    <div class="llm-comment-card">
                        <p class="text-sm text-gray-700" id="lapTimeEvolutionComment"><strong class="font-fredoka">Bielik Analizuje:</strong> Wow, Wojtek! Zobacz na ten wykres! Twoje czasy pikujƒÖ w d√≥≈Ç niczym Bielik na polowaniu na rekordy! Widaƒá, ≈ºe ciƒô≈ºko pracujesz i to przynosi efekty. Szczeg√≥lnie imponujƒÖcy jest skok miƒôdzy 4. a 5. sesjƒÖ ‚Äì co tam siƒô wydarzy≈Ço? Jaka≈õ nowa technika? Super! Tak trzymaj, a nied≈Çugo bƒôdziesz lata≈Ç jak ja! üòâ</p>
                    </div>
                    <div id="geminiAdviceLapTime" class="gemini-response-card hidden"></div>
                    <button class="button-cartoon button-gemini mt-4 py-2 px-4 w-full" onclick="getGeminiAdvice('lapTimeEvolution')">‚ú® Zapytaj Super-Bielika o Radƒô! <span id="loadingLapTime" class="loading-spinner hidden"></span></button>
                </div>
                <div class="chart-container">
                    <h3 class="text-xl font-fredoka text-center mb-4 text-gray-700">Poprawa w Sektorach (≈örednia: Pierwsze 5 vs Ostatnie 5 Sesji)</h3>
                    <canvas id="sectorImprovementChart"></canvas>
                     <div class="llm-comment-card">
                        <p class="text-sm text-gray-700" id="sectorImprovementComment"><strong class="font-fredoka">Bielik Podpowiada:</strong> Patrz, patrz! Sektor 2 to teraz Twoje kr√≥lestwo ‚Äì najwiƒôksza poprawa! üí™ To pokazuje, ≈ºe skupienie na konkretnych czƒô≈õciach toru daje super rezultaty. Sektor 1 te≈º wyglƒÖda coraz lepiej. Mo≈ºe nastƒôpnym razem po≈õwiƒôcimy wiƒôcej uwagi Sektorowi 3? Widzƒô tam jeszcze ukryty potencja≈Ç do urwania cennych dziesiƒÖtych sekundy! Co Ty na to, m≈Çody Orle?</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="last-session" class="mb-12">
            <h2 class="text-3xl sm:text-4xl font-fredoka text-center mb-8 text-gray-800 section-title-dashboard">Analiza Ostatniej Szar≈ºy! (Sesja z 21.05.2025) üßê</h2>
            <div class="grid lg:grid-cols-2 gap-8">
                <div class="chart-container">
                    <h3 class="text-xl font-fredoka text-center mb-4 text-gray-700">Czasy OkrƒÖ≈ºe≈Ñ z Ostatniej Sesji</h3>
                    <canvas id="lastSessionLapsChart"></canvas>
                    <div class="llm-comment-card">
                        <p class="text-sm text-gray-700"><strong class="font-fredoka">Bielik Komentuje:</strong> Hoho! Ostatnia sesja by≈Ça naprawdƒô ODLOTOWA! Twoje najlepsze okrƒÖ≈ºenie (1:03.112) to prawdziwy majstersztyk! Widaƒá te≈º fajnƒÖ powtarzalno≈õƒá w ≈õrodkowej czƒô≈õci sesji. Te kilka wolniejszych k√≥≈Çek na poczƒÖtku to pewnie rozgrzewka opon, co? üòâ Wa≈ºne, ≈ºe potem pokaza≈Çe≈õ pazur!</p>
                    </div>
                </div>
                <div class="chart-container">
                    <h3 class="text-xl font-fredoka text-center mb-4 text-gray-700">Profil Prƒôdko≈õci Najlepszego OkrƒÖ≈ºenia vs. Benchmark Bielika</h3>
                    <canvas id="speedProfileChart"></canvas>
                    <div class="llm-comment-card">
                        <p class="text-sm text-gray-700"><strong class="font-fredoka">Bielik Por√≥wnuje:</strong> A teraz zobaczmy, jak Twoje najlepsze k√≥≈Çko wypada na tle mojego benchmarku! W Zakrƒôcie Le≈õnym (ok. 800m) jedziesz prawie jak ja ‚Äì super! Ale sp√≥jrz na wyj≈õcie z Nawrotu (ok. 1200m) ‚Äì tam mo≈ºesz jeszcze troszkƒô wcze≈õniej dodaƒá gazu. M√≥j benchmark pokazuje, ≈ºe jest tam przestrze≈Ñ do poprawy. Dasz radƒô nastƒôpnym razem! üëç</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="bielik-tips" class="mb-12">
            <h2 class="text-3xl sm:text-4xl font-fredoka text-center mb-8 text-gray-800 section-title-dashboard">Bielik Radzi: Twoje Orle Wskaz√≥wki! üí°</h2>
            <div class="grid md:grid-cols-3 gap-6">
                <div class="dashboard-card p-6">
                    <img src="https://placehold.co/80x80/FEE2E2/EF4444?text=üéØ" alt="Celownik" class="mx-auto mb-3 h-16 w-16">
                    <h3 class="text-xl font-fredoka text-center text-gray-700 mb-2">G≈Ç√≥wny Cel na Horyzoncie</h3>
                    <div class="llm-comment-card">
                        <p class="text-sm text-gray-700" id="mainGoalComment"><strong class="font-fredoka">Bielik M√≥wi:</strong> Wojtek, Tw√≥j punkt hamowania przed Nawrotem (tym ostatnim, wrednym!) jest troszkƒô za wczesny. To jakby Bielik lƒÖdowa≈Ç za wcze≈õnie przed gniazdem! Spr√≥buj op√≥≈∫niƒá go o d≈Çugo≈õƒá gokarta ‚Äì poczujesz r√≥≈ºnicƒô na wyj≈õciu i zyskasz cenne u≈Çamki sekund! Pamiƒôtaj, Or≈Çy nie bojƒÖ siƒô p√≥≈∫nego hamowania, gdy sytuacja tego wymaga! üòâ</p>
                    </div>
                    <div id="geminiAdviceMainGoal" class="gemini-response-card hidden"></div>
                    <button class="button-cartoon button-gemini mt-4 py-2 px-4 w-full" onclick="getGeminiAdvice('mainGoal')">‚ú® Dopytaj Super-Bielika! <span id="loadingMainGoal" class="loading-spinner hidden"></span></button>
                </div>
                <div class="dashboard-card p-6">
                    <img src="https://placehold.co/80x80/D1FAE5/10B981?text=üí™" alt="Biceps/Si≈Ça" class="mx-auto mb-3 h-16 w-16">
                    <h3 class="text-xl font-fredoka text-center text-gray-700 mb-2">Twoja Super-Moc!</h3>
                     <div class="llm-comment-card">
                        <p class="text-sm text-gray-700"><strong class="font-fredoka">Bielik Chwali:</strong> Szykana Le≈õna to Tw√≥j ≈ºywio≈Ç! Przechodzisz jƒÖ z gracjƒÖ i prƒôdko≈õciƒÖ godnƒÖ kr√≥la przestworzy. Twoja p≈Çynno≈õƒá tam jest imponujƒÖca ‚Äì jak lot Bielika na termice! Wykorzystaj tƒô umiejƒôtno≈õƒá, by zyskaƒá przewagƒô nad rywalami i budowaƒá pewno≈õƒá siebie! Brawo Ty! üåü</p>
                    </div>
                </div>
                <div class="dashboard-card p-6">
                    <img src="https://placehold.co/80x80/DBEAFE/3B82F6?text=üöÄ" alt="Rakieta/Wyzwanie" class="mx-auto mb-3 h-16 w-16">
                    <h3 class="text-xl font-fredoka text-center text-gray-700 mb-2">Wyzwanie Bielika!</h3>
                    <div class="llm-comment-card">
                        <p class="text-sm text-gray-700"><strong class="font-fredoka">Bielik Rzuca Wyzwanie:</strong> Przyjmujesz wyzwanie, m≈Çody Orle? Skup siƒô na Sektorze 1 podczas nastƒôpnej jazdy. Moje AI-oko widzi tam potencja≈Ç na urwanie co najmniej 0.150 sekundy! Skoncentruj siƒô na p≈Çynnym wyj≈õciu z pierwszego zakrƒôtu i optymalnym wykorzystaniu tarki. Wierzƒô, ≈ºe dasz radƒô! Poka≈º, na co Ciƒô staƒá! Powodzenia! üèÜ</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="training-plan" class="mb-12">
            <h2 class="text-3xl sm:text-4xl font-fredoka text-center mb-8 text-gray-800 section-title-dashboard">‚ú® Plan Treningowy od Genera≈Ça Bielika! ‚ú®</h2>
            <div class="dashboard-card p-6">
                <div class="text-center mb-6">
                    <img src="https://placehold.co/100x100/F59E0B/FFFFFF?text=üìú+ü¶Ö" alt="Bielik z planem treningowym" class="mx-auto mb-3 h-20 w-20">
                    <p class="text-gray-600">Genera≈Ç Bielik przeanalizowa≈Ç Twoje ostatnie loty i przygotowa≈Ç specjalny plan treningowy na najbli≈ºszy tydzie≈Ñ, aby≈õ wzbi≈Ç siƒô na jeszcze wy≈ºszy poziom! Got√≥w na wyzwanie?</p>
                </div>
                <div id="geminiTrainingPlan" class="gemini-response-card hidden min-h-[150px]">
                    <p class="text-center text-gray-500">Kliknij przycisk, aby Bielik wygenerowa≈Ç Tw√≥j plan!</p>
                </div>
                <button class="button-cartoon button-gemini mt-6 py-3 px-6 w-full text-lg" onclick="generateTrainingPlan()">
                    ‚ú® Generuj M√≥j Orli Plan Treningowy! 
                    <span id="loadingTrainingPlan" class="loading-spinner hidden"></span>
                </button>
            </div>
        </section>

    </main>

    <footer class="py-8 bg-gray-800 text-center border-t-4 bielik-red-border">
        <div class="container mx-auto px-6">
            <p class="text-gray-300 text-sm">&copy; <span id="currentYearV7_dashboard"></span> Perun AI. Wszelkie prawa zastrze≈ºone przez Naczelnego Bielika i jego Super-Dru≈ºynƒô Analityk√≥w.</p>
            <p class="text-gray-400 text-xs mt-1">Analizujemy, by≈õ Ty m√≥g≈Ç lataƒá... po torze! üèÅü¶Öüéâ</p>
        </div>
    </footer>

    <script>
        // Aktualizacja roku w stopce
        document.getElementById('currentYearV7_dashboard').textContent = new Date().getFullYear();

        // Dane do wykres√≥w (przyk≈Çadowe)
        const lapTimeData = {
            labels: ['Sesja 1', 'Sesja 2', 'Sesja 3', 'Sesja 4', 'Sesja 5', 'Sesja 6', 'Sesja 7', 'Sesja 8', 'Sesja 9', 'Sesja 10'],
            datasets: [{
                label: 'Najlepszy Czas OkrƒÖ≈ºenia (s)',
                data: [65.2, 64.8, 64.9, 64.5, 63.8, 63.9, 63.5, 63.2, 63.3, 62.8],
                borderColor: '#3B82F6', 
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.1,
                fill: true,
                borderWidth: 2
            }]
        };
        // ... (reszta danych wykres√≥w bez zmian) ...
        const sectorImprovementData = {
            labels: ['Sektor 1', 'Sektor 2', 'Sektor 3'],
            datasets: [
                {
                    label: '≈ör. Czas - Pierwsze 5 Sesji (s)',
                    data: [22.5, 20.8, 21.5],
                    backgroundColor: '#FBBF24', 
                    borderColor: '#F59E0B',
                    borderWidth: 1
                },
                {
                    label: '≈ör. Czas - Ostatnie 5 Sesji (s)',
                    data: [22.1, 19.9, 21.2],
                    backgroundColor: '#10B981', 
                    borderColor: '#059669',
                    borderWidth: 1
                }
            ]
        };
        
        const lastSessionLapsData = {
            labels: ['Okr. 1', 'Okr. 2', 'Okr. 3', 'Okr. 4', 'Okr. 5', 'Okr. 6', 'Okr. 7', 'Okr. 8', 'Okr. 9', 'Okr. 10'],
            datasets: [{
                label: 'Czas OkrƒÖ≈ºenia (s)',
                data: [65.1, 64.5, 63.8, 63.5, 63.112, 63.3, 63.4, 63.2, 64.0, 63.6],
                borderColor: '#EF4444', 
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.1,
                fill: true,
                borderWidth: 2
            }]
        };

        const speedProfileData = {
            labels: Array.from({length: 15}, (_, i) => `${i*100}m`), 
            datasets: [
                {
                    label: 'Twoja Prƒôdko≈õƒá (km/h)',
                    data: [0, 30, 55, 70, 65, 50, 40, 60, 75, 80, 70, 55, 45, 65, 0],
                    borderColor: '#3B82F6', 
                    tension: 0.2,
                    borderWidth: 3,
                    pointRadius: 0,
                },
                {
                    label: 'Benchmark Bielika (km/h)',
                    data: [0, 32, 58, 72, 68, 53, 42, 63, 78, 82, 73, 58, 48, 68, 0],
                    borderColor: '#F59E0B', 
                    borderDash: [5, 5],
                    tension: 0.2,
                    borderWidth: 2,
                    pointRadius: 0,
                }
            ]
        };


        // Inicjalizacja wykres√≥w
        window.onload = function() {
            const ctxLapTime = document.getElementById('lapTimeEvolutionChart')?.getContext('2d');
            if (ctxLapTime) new Chart(ctxLapTime, { type: 'line', data: lapTimeData, options: { responsive: true, maintainAspectRatio: false } });

            const ctxSectorImprovement = document.getElementById('sectorImprovementChart')?.getContext('2d');
            if (ctxSectorImprovement) new Chart(ctxSectorImprovement, { type: 'bar', data: sectorImprovementData, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true }} } });
            
            const ctxLastSessionLaps = document.getElementById('lastSessionLapsChart')?.getContext('2d');
            if (ctxLastSessionLaps) new Chart(ctxLastSessionLaps, { type: 'line', data: lastSessionLapsData, options: { responsive: true, maintainAspectRatio: false } });

            const ctxSpeedProfile = document.getElementById('speedProfileChart')?.getContext('2d');
            if (ctxSpeedProfile) new Chart(ctxSpeedProfile, { type: 'line', data: speedProfileData, options: { responsive: true, maintainAspectRatio: false, elements: { line: { fill: false } } } });
        };

        // Funkcje Gemini API
        const apiKey = ""; // Klucz API - pozostaw pusty, Canvas dostarczy go w runtime

        async function callGeminiAPI(prompt) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("B≈ÇƒÖd API:", response.status, errorData);
                    return `Przepraszam, Super-Bielik ma chwilowƒÖ czkawkƒô i nie mo≈ºe teraz odpowiedzieƒá (B≈ÇƒÖd: ${response.status}). Spr√≥buj za moment!`;
                }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Nieoczekiwana struktura odpowiedzi:", result);
                    return "Hmm, Super-Bielik zgubi≈Ç gdzie≈õ swoje mƒÖdre s≈Çowa. Spr√≥buj jeszcze raz!";
                }
            } catch (error) {
                console.error("B≈ÇƒÖd po≈ÇƒÖczenia z API Gemini:", error);
                return "Ojej! WyglƒÖda na to, ≈ºe go≈ÇƒÖb pocztowy z mojƒÖ odpowiedziƒÖ zgubi≈Ç siƒô w chmurach. Sprawd≈∫ po≈ÇƒÖczenie i spr√≥buj ponownie!";
            }
        }

        async function getGeminiAdvice(adviceType) {
            let promptContext = "";
            let responseElementId = "";
            let loadingElementId = "";
            const userName = document.getElementById('userName')?.textContent || "Kierowco";

            if (adviceType === 'lapTimeEvolution') {
                const lapTimes = lapTimeData.datasets[0].data.join(', ');
                const currentComment = document.getElementById('lapTimeEvolutionComment')?.innerText || "Twoje czasy okrƒÖ≈ºe≈Ñ ewoluujƒÖ.";
                promptContext = `Jestem amatorem kartingu, ${userName}. Moje ostatnie 10 najlepszych czas√≥w okrƒÖ≈ºe≈Ñ to: ${lapTimes} sekund. M√≥j obecny komentarz od trenera Bielika brzmi: "${currentComment}".`;
                responseElementId = 'geminiAdviceLapTime';
                loadingElementId = 'loadingLapTime';
                document.getElementById(loadingElementId).classList.remove('hidden');
                const prompt = `${promptContext} Jako Super-Bielik, m√≥j jeszcze mƒÖdrzejszy trener AI, podpowiedz mi w zabawny i motywujƒÖcy spos√≥b, na czym powinienem siƒô teraz skupiƒá, aby dalej poprawiaƒá swoje czasy? Daj mi 2-3 konkretne, kr√≥tkie wskaz√≥wki. Pamiƒôtaj o swoim orlim stylu! Odpowiedz po polsku.`;
                const advice = await callGeminiAPI(prompt);
                const responseCard = document.getElementById(responseElementId);
                responseCard.innerHTML = `<p class="text-sm text-gray-700"><strong class="font-fredoka">Super-Bielik Radzi:</strong> ${advice.replace(/\n/g, '<br>')}</p>`;
                responseCard.classList.remove('hidden');
                document.getElementById(loadingElementId).classList.add('hidden');

            } else if (adviceType === 'mainGoal') {
                const currentGoalComment = document.getElementById('mainGoalComment')?.innerText || "Masz cel dotyczƒÖcy punktu hamowania.";
                promptContext = `Jestem amatorem kartingu, ${userName}. M√≥j obecny g≈Ç√≥wny cel od trenera Bielika to: "${currentGoalComment}".`;
                responseElementId = 'geminiAdviceMainGoal';
                loadingElementId = 'loadingMainGoal';
                document.getElementById(loadingElementId).classList.remove('hidden');
                const prompt = `${promptContext} Jako Super-Bielik, m√≥j super-inteligentny trener AI, rozwi≈Ñ tƒô poradƒô. Daj mi jednƒÖ dodatkowƒÖ, kreatywnƒÖ wskaz√≥wkƒô lub ƒáwiczenie, kt√≥re pomo≈ºe mi zrealizowaƒá ten cel. Utrzymaj zabawny, orli ton! Odpowiedz po polsku.`;
                const advice = await callGeminiAPI(prompt);
                const responseCard = document.getElementById(responseElementId);
                responseCard.innerHTML = `<p class="text-sm text-gray-700"><strong class="font-fredoka">Super-Bielik Precyzuje:</strong> ${advice.replace(/\n/g, '<br>')}</p>`;
                responseCard.classList.remove('hidden');
                document.getElementById(loadingElementId).classList.add('hidden');
            }
        }

        async function generateTrainingPlan() {
            const loadingElement = document.getElementById('loadingTrainingPlan');
            const responseElement = document.getElementById('geminiTrainingPlan');
            const userName = document.getElementById('userName')?.textContent || "Drogi Kierowco";
            const bestLap = document.getElementById('bestLapTime')?.textContent || "nieznany";
            const lastSession = document.getElementById('lastSessionTime')?.textContent || "nieznana";
            const sectorImprovementComment = document.getElementById('sectorImprovementComment')?.innerText || "brak danych o sektorach";
            const mainGoalComment = document.getElementById('mainGoalComment')?.innerText || "brak g≈Ç√≥wnego celu";

            loadingElement.classList.remove('hidden');
            responseElement.innerHTML = `<p class="text-center text-gray-500">Genera≈Ç Bielik ju≈º kombinuje Tw√≥j plan... To wymaga skupienia!</p>`;
            responseElement.classList.remove('hidden');

            const prompt = `Jako Genera≈Ç Bielik, najwy≈ºszy rangƒÖ trener AI dla kierowcy kartingowego o imieniu ${userName}, przygotuj spersonalizowany, tygodniowy plan treningowy. 
            Oto podsumowanie jego ostatnich osiƒÖgniƒôƒá:
            - Najlepszy czas okrƒÖ≈ºenia: ${bestLap}
            - Czas ostatniej sesji: ${lastSession}
            - Komentarz dotyczƒÖcy poprawy w sektorach: "${sectorImprovementComment}"
            - G≈Ç√≥wny cel od trenera Bielika: "${mainGoalComment}"

            Plan powinien byƒá zabawny, motywujƒÖcy i zawieraƒá:
            1.  G≈Ç√≥wny cel na ten tydzie≈Ñ (1 zdanie).
            2.  Trzy kluczowe obszary do poprawy (np. technika hamowania, p≈Çynno≈õƒá w szykanach, koncentracja).
            3.  Propozycje 2-3 konkretnych ƒáwicze≈Ñ lub zada≈Ñ na torze (je≈õli to mo≈ºliwe) lub mentalnych do wykonania w tygodniu.
            4.  Kr√≥tkƒÖ, orlƒÖ poradƒô motywacyjnƒÖ na koniec.
            Pamiƒôtaj o swoim generalskim, ale wciƒÖ≈º zabawnym i kresk√≥wkowym stylu! Odpowiedz po polsku, u≈ºywajƒÖc formatowania markdown (np. nag≈Ç√≥wki, listy).`;

            const plan = await callGeminiAPI(prompt);
            // Proste parsowanie markdown do HTML (mo≈ºna rozbudowaƒá)
            let htmlPlan = plan.replace(/\n\n/g, '<br><br>').replace(/\n/g, '<br>');
            htmlPlan = htmlPlan.replace(/### (.*?)<br>/g, '<h3><strong>$1</strong></h3>');
            htmlPlan = htmlPlan.replace(/## (.*?)<br>/g, '<h2><strong>$1</strong></h2>');
            htmlPlan = htmlPlan.replace(/\* (.*?)<br>/g, '<li>$1</li>');
            htmlPlan = htmlPlan.replace(/<br><li>/g, '<li>'); // Poprawka dla list
             if (htmlPlan.includes('<li>')) {
                htmlPlan = '<ul>' + htmlPlan.replace(/<li>(.*?)<\/li>/g, '<li class="list-disc ml-5">$1</li>') + '</ul>';
                htmlPlan = htmlPlan.replace(/<\/li><br><ul>/g, '</li></ul><br><ul>'); // Poprawka dla wielokrotnych list
            }


            responseElement.innerHTML = `<div class="text-sm text-gray-700">${htmlPlan}</div>`;
            loadingElement.classList.add('hidden');
        }

    </script>
</body>
</html>
