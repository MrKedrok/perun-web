<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Analityczny Orlego Kierowcy - Perun AI</title>
    <meta name="description" content="Zobacz swoje postÄ™py na torze z Perun AI! Analiza historyczna i bieÅ¼Ä…ca, wykresy i wskazÃ³wki od Twojego Bielika Trenera, teraz z mocÄ… Gemini API!">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            scroll-behavior: smooth;
            background-color: #E0F2FE; /* Bardzo jasny bÅ‚Ä™kit, jak niebo */
            color: #1F2937; 
        }
        .font-fredoka {
            font-family: 'Fredoka One', cursive;
        }
        
        .bielik-red { color: #EF4444; } 
        .bielik-red-bg { background-color: #EF4444; }
        .bielik-red-bg-hover:hover { background-color: #DC2626; }

        .bielik-blue { color: #3B82F6; } 
        .bielik-blue-bg { background-color: #3B82F6; }
        .bielik-blue-bg-hover:hover { background-color: #2563EB; }

        .bielik-yellow { color: #F59E0B; } 
        .bielik-yellow-bg { background-color: #F59E0B; }

        .bielik-green { color: #10B981; }
        .bielik-green-bg { background-color: #10B981; }
        
        .dashboard-card {
            background: white;
            border: 3px solid #1F2937; 
            box-shadow: 6px 6px 0px #9CA3AF; /* Szary cieÅ„ dla kart dashboardu */
            transition: all 0.2s ease-out;
            border-radius: 16px;
        }
        .dashboard-card:hover {
            transform: translate(-4px, -4px);
            box-shadow: 10px 10px 0px #3B82F6; /* Niebieski cieÅ„ przy hover */
        }
        .button-cartoon { 
            border: 3px solid #1F2937;
            box-shadow: 4px 4px 0px #1F2937;
            transition: all 0.15s ease-out !important;
            font-weight: 800; 
            border-radius: 8px;
            cursor: pointer;
        }
        .button-cartoon:hover {
            transform: translate(-2px, -2px) !important;
            box-shadow: 6px 6px 0px #1F2937 !important;
            background-color: #F59E0B;
            color: #1F2937;
        }
        .button-cartoon:active {
            transform: translate(2px, 2px) !important;
            box-shadow: 2px 2px 0px #1F2937 !important;
        }
        .button-gemini { /* Specjalny styl dla przyciskÃ³w Gemini */
            background-color: #F59E0B; /* Å»Ã³Å‚ty */
            color: #1F2937;
        }
        .button-gemini:hover {
            background-color: #EF4444; /* Czerwony przy hover */
            color: white;
        }
        .section-title-dashboard {
            text-shadow: 2px 2px 0px #A5F3FC, 4px 4px 0px #67E8F9; /* Jasnoniebieski cieÅ„ */
        }
        .llm-comment-card {
            background-color: #FFFAE5; 
            border: 2px dashed #F59E0B; 
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
            position: relative;
        }
        .llm-comment-card::before { 
            content: "";
            position: absolute;
            bottom: 100%;
            left: 30px;
            border-width: 10px;
            border-style: solid;
            border-color: transparent transparent #F59E0B transparent;
        }
        .llm-comment-card strong {
            color: #D97706; 
        }
        .gemini-response-card { /* Styl dla odpowiedzi od Gemini */
            background-color: #E0FEFE; /* Jasno-turkusowe tÅ‚o */
            border: 2px dashed #00E6E6; 
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
            position: relative;
        }
        .gemini-response-card::before {
            content: "âœ¨";
            position: absolute;
            top: -15px;
            left: 10px;
            font-size: 1.8rem;
            transform: rotate(-15deg);
        }
        .gemini-response-card strong {
            color: #008080; /* Ciemniejszy turkus */
        }
        .chart-container {
            padding: 1.5rem;
            border-radius: 12px;
            background-color: #FFFFFF;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 1rem; /* Zmniejszony margines */
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3B82F6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased">

    <header class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center">
                <img src="https://placehold.co/60x60/3B82F6/FFFFFF?text=ğŸ¦…" alt="Logo Perun AI - KreskÃ³wkowy Bielik" class="h-10 w-10 sm:h-12 sm:w-12 mr-3 rounded-full">
                <h1 class="text-2xl sm:text-3xl font-fredoka bielik-blue">
                    PERUN<span class="bielik-red">.AI</span> <span class="text-lg sm:text-xl text-gray-600 font-nunito">- Panel Orlego Kierowcy</span>
                </h1>
            </div>
            <span class="font-semibold text-gray-700 text-sm sm:text-base">Witaj, Wojtek OrliÅ„ski!</span>
        </div>
    </header>

    <main class="container mx-auto px-4 sm:px-6 py-8">

        <section id="summary" class="mb-12">
            <h2 class="text-3xl sm:text-4xl font-fredoka text-center mb-8 text-gray-800 section-title-dashboard">TwÃ³j Orli PrzeglÄ…d OsiÄ…gniÄ™Ä‡! ğŸ“Š</h2>
            <div class="grid md:grid-cols-3 gap-6 mb-6">
                <div class="dashboard-card p-6 text-center">
                    <img src="https://placehold.co/80x80/FEF3C7/F59E0B?text=ğŸ†" alt="Puchar za najlepszy czas" class="mx-auto mb-3 h-16 w-16">
                    <h3 class="text-xl font-fredoka text-gray-700 mb-1">Najlepszy Czas OkrÄ…Å¼enia</h3>
                    <p class="text-3xl font-bold bielik-red" id="bestLapTime">1:02.345</p>
                    <p class="text-sm text-gray-500">(Sesja z 20.05.2025)</p>
                </div>
                <div class="dashboard-card p-6 text-center">
                    <img src="https://placehold.co/80x80/DBEAFE/3B82F6?text=ğŸï¸ğŸ’¨" alt="Gokart w ruchu" class="mx-auto mb-3 h-16 w-16">
                    <h3 class="text-xl font-fredoka text-gray-700 mb-1">ÅÄ…czna Liczba PrzejazdÃ³w</h3>
                    <p class="text-3xl font-bold bielik-blue">128</p>
                    <p class="text-sm text-gray-500">Od poczÄ…tku przygody!</p>
                </div>
                <div class="dashboard-card p-6 text-center">
                     <img src="https://placehold.co/80x80/D1FAE5/10B981?text=ğŸ“…" alt="Kalendarz z ostatniÄ… sesjÄ…" class="mx-auto mb-3 h-16 w-16">
                    <h3 class="text-xl font-fredoka text-gray-700 mb-1">Ostatnia Sesja</h3>
                    <p class="text-2xl font-bold bielik-green" id="lastSessionTime">1:03.112</p>
                    <p class="text-sm text-gray-500">(21.05.2025 - Tor KartPlanet)</p>
                </div>
            </div>
            <div class="llm-comment-card">
                <p class="text-gray-700"><strong class="font-fredoka">Bielik MÃ³wi:</strong> Hej, <strong id="userName">Wojtek OrliÅ„ski</strong>! TwÃ³j Orli Panel jest gotowy do startu! Zobaczmy, jak dzisiaj szybowaÅ‚eÅ› po torze! PamiÄ™taj, kaÅ¼dy lot, nawet ten z maÅ‚ym potkniÄ™ciem o krawÄ™Å¼nik, to krok do mistrzostwa i super zabawy! Jestem tu, by pomÃ³c Ci rozwinÄ…Ä‡ skrzydÅ‚a! ğŸ¦…ğŸ’¨</p>
            </div>
        </section>

        <section id="progress" class="mb-12">
            <h2 class="text-3xl sm:text-4xl font-fredoka text-center mb-8 text-gray-800 section-title-dashboard">TwÃ³j Lot ku Mistrzostwu! ğŸ“ˆ</h2>
            <div class="grid lg:grid-cols-2 gap-8">
                <div class="chart-container">
                    <h3 class="text-xl font-fredoka text-center mb-4 text-gray-700">Ewolucja Czasu OkrÄ…Å¼enia (Ostatnie 10 Sesji)</h3>
                    <canvas id="lapTimeEvolutionChart"></canvas>
                    <div class="llm-comment-card">
                        <p class="text-sm text-gray-700" id="lapTimeEvolutionComment"><strong class="font-fredoka">Bielik Analizuje:</strong> Wow, Wojtek! Zobacz na ten wykres! Twoje czasy pikujÄ… w dÃ³Å‚ niczym Bielik na polowaniu na rekordy! WidaÄ‡, Å¼e ciÄ™Å¼ko pracujesz i to przynosi efekty. SzczegÃ³lnie imponujÄ…cy jest skok miÄ™dzy 4. a 5. sesjÄ… â€“ co tam siÄ™ wydarzyÅ‚o? JakaÅ› nowa technika? Super! Tak trzymaj, a niedÅ‚ugo bÄ™dziesz lataÅ‚ jak ja! ğŸ˜‰</p>
                    </div>
                    <div id="geminiAdviceLapTime" class="gemini-response-card hidden"></div>
                    <button class="button-cartoon button-gemini mt-4 py-2 px-4 w-full" onclick="getGeminiAdvice('lapTimeEvolution')">âœ¨ Zapytaj Super-Bielika o RadÄ™! <span id="loadingLapTime" class="loading-spinner hidden"></span></button>
                </div>
                <div class="chart-container">
                    <h3 class="text-xl font-fredoka text-center mb-4 text-gray-700">Poprawa w Sektorach (Åšrednia: Pierwsze 5 vs Ostatnie 5 Sesji)</h3>
                    <canvas id="sectorImprovementChart"></canvas>
                     <div class="llm-comment-card">
                        <p class="text-sm text-gray-700" id="sectorImprovementComment"><strong class="font-fredoka">Bielik Podpowiada:</strong> Patrz, patrz! Sektor 2 to teraz Twoje krÃ³lestwo â€“ najwiÄ™ksza poprawa! ğŸ’ª To pokazuje, Å¼e skupienie na konkretnych czÄ™Å›ciach toru daje super rezultaty. Sektor 1 teÅ¼ wyglÄ…da coraz lepiej. MoÅ¼e nastÄ™pnym razem poÅ›wiÄ™cimy wiÄ™cej uwagi Sektorowi 3? WidzÄ™ tam jeszcze ukryty potencjaÅ‚ do urwania cennych dziesiÄ…tych sekundy! Co Ty na to, mÅ‚ody Orle?</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="last-session" class="mb-12">
            <h2 class="text-3xl sm:text-4xl font-fredoka text-center mb-8 text-gray-800 section-title-dashboard">Analiza Ostatniej SzarÅ¼y! (Sesja z 21.05.2025) ğŸ§</h2>
            <div class="grid lg:grid-cols-2 gap-8">
                <div class="chart-container">
                    <h3 class="text-xl font-fredoka text-center mb-4 text-gray-700">Czasy OkrÄ…Å¼eÅ„ z Ostatniej Sesji</h3>
                    <canvas id="lastSessionLapsChart"></canvas>
                    <div class="llm-comment-card">
                        <p class="text-sm text-gray-700"><strong class="font-fredoka">Bielik Komentuje:</strong> Hoho! Ostatnia sesja byÅ‚a naprawdÄ™ ODLOTOWA! Twoje najlepsze okrÄ…Å¼enie (1:03.112) to prawdziwy majstersztyk! WidaÄ‡ teÅ¼ fajnÄ… powtarzalnoÅ›Ä‡ w Å›rodkowej czÄ™Å›ci sesji. Te kilka wolniejszych kÃ³Å‚ek na poczÄ…tku to pewnie rozgrzewka opon, co? ğŸ˜‰ WaÅ¼ne, Å¼e potem pokazaÅ‚eÅ› pazur!</p>
                    </div>
                </div>
                <div class="chart-container">
                    <h3 class="text-xl font-fredoka text-center mb-4 text-gray-700">Profil PrÄ™dkoÅ›ci Najlepszego OkrÄ…Å¼enia vs. Benchmark Bielika</h3>
                    <canvas id="speedProfileChart"></canvas>
                    <div class="llm-comment-card">
                        <p class="text-sm text-gray-700"><strong class="font-fredoka">Bielik PorÃ³wnuje:</strong> A teraz zobaczmy, jak Twoje najlepsze kÃ³Å‚ko wypada na tle mojego benchmarku! W ZakrÄ™cie LeÅ›nym (ok. 800m) jedziesz prawie jak ja â€“ super! Ale spÃ³jrz na wyjÅ›cie z Nawrotu (ok. 1200m) â€“ tam moÅ¼esz jeszcze troszkÄ™ wczeÅ›niej dodaÄ‡ gazu. MÃ³j benchmark pokazuje, Å¼e jest tam przestrzeÅ„ do poprawy. Dasz radÄ™ nastÄ™pnym razem! ğŸ‘</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="bielik-tips" class="mb-12">
            <h2 class="text-3xl sm:text-4xl font-fredoka text-center mb-8 text-gray-800 section-title-dashboard">Bielik Radzi: Twoje Orle WskazÃ³wki! ğŸ’¡</h2>
            <div class="grid md:grid-cols-3 gap-6">
                <div class="dashboard-card p-6">
                    <img src="https://placehold.co/80x80/FEE2E2/EF4444?text=ğŸ¯" alt="Celownik" class="mx-auto mb-3 h-16 w-16">
                    <h3 class="text-xl font-fredoka text-center text-gray-700 mb-2">GÅ‚Ã³wny Cel na Horyzoncie</h3>
                    <div class="llm-comment-card">
                        <p class="text-sm text-gray-700" id="mainGoalComment"><strong class="font-fredoka">Bielik MÃ³wi:</strong> Wojtek, TwÃ³j punkt hamowania przed Nawrotem (tym ostatnim, wrednym!) jest troszkÄ™ za wczesny. To jakby Bielik lÄ…dowaÅ‚ za wczeÅ›nie przed gniazdem! SprÃ³buj opÃ³ÅºniÄ‡ go o dÅ‚ugoÅ›Ä‡ gokarta â€“ poczujesz rÃ³Å¼nicÄ™ na wyjÅ›ciu i zyskasz cenne uÅ‚amki sekund! PamiÄ™taj, OrÅ‚y nie bojÄ… siÄ™ pÃ³Åºnego hamowania, gdy sytuacja tego wymaga! ğŸ˜‰</p>
                    </div>
                    <div id="geminiAdviceMainGoal" class="gemini-response-card hidden"></div>
                    <button class="button-cartoon button-gemini mt-4 py-2 px-4 w-full" onclick="getGeminiAdvice('mainGoal')">âœ¨ Dopytaj Super-Bielika! <span id="loadingMainGoal" class="loading-spinner hidden"></span></button>
                </div>
                <div class="dashboard-card p-6">
                    <img src="https://placehold.co/80x80/D1FAE5/10B981?text=ğŸ’ª" alt="Biceps/SiÅ‚a" class="mx-auto mb-3 h-16 w-16">
                    <h3 class="text-xl font-fredoka text-center text-gray-700 mb-2">Twoja Super-Moc!</h3>
                     <div class="llm-comment-card">
                        <p class="text-sm text-gray-700"><strong class="font-fredoka">Bielik Chwali:</strong> Szykana LeÅ›na to TwÃ³j Å¼ywioÅ‚! Przechodzisz jÄ… z gracjÄ… i prÄ™dkoÅ›ciÄ… godnÄ… krÃ³la przestworzy. Twoja pÅ‚ynnoÅ›Ä‡ tam jest imponujÄ…ca â€“ jak lot Bielika na termice! Wykorzystaj tÄ™ umiejÄ™tnoÅ›Ä‡, by zyskaÄ‡ przewagÄ™ nad rywalami i budowaÄ‡ pewnoÅ›Ä‡ siebie! Brawo Ty! ğŸŒŸ</p>
                    </div>
                </div>
                <div class="dashboard-card p-6">
                    <img src="https://placehold.co/80x80/DBEAFE/3B82F6?text=ğŸš€" alt="Rakieta/Wyzwanie" class="mx-auto mb-3 h-16 w-16">
                    <h3 class="text-xl font-fredoka text-center text-gray-700 mb-2">Wyzwanie Bielika!</h3>
                    <div class="llm-comment-card">
                        <p class="text-sm text-gray-700"><strong class="font-fredoka">Bielik Rzuca Wyzwanie:</strong> Przyjmujesz wyzwanie, mÅ‚ody Orle? Skup siÄ™ na Sektorze 1 podczas nastÄ™pnej jazdy. Moje AI-oko widzi tam potencjaÅ‚ na urwanie co najmniej 0.150 sekundy! Skoncentruj siÄ™ na pÅ‚ynnym wyjÅ›ciu z pierwszego zakrÄ™tu i optymalnym wykorzystaniu tarki. WierzÄ™, Å¼e dasz radÄ™! PokaÅ¼, na co CiÄ™ staÄ‡! Powodzenia! ğŸ†</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="training-plan" class="mb-12">
            <h2 class="text-3xl sm:text-4xl font-fredoka text-center mb-8 text-gray-800 section-title-dashboard">âœ¨ Plan Treningowy od GeneraÅ‚a Bielika! âœ¨</h2>
            <div class="dashboard-card p-6">
                <div class="text-center mb-6">
                    <img src="https://placehold.co/100x100/F59E0B/FFFFFF?text=ğŸ“œ+ğŸ¦…" alt="Bielik z planem treningowym" class="mx-auto mb-3 h-20 w-20">
                    <p class="text-gray-600">GeneraÅ‚ Bielik przeanalizowaÅ‚ Twoje ostatnie loty i przygotowaÅ‚ specjalny plan treningowy na najbliÅ¼szy tydzieÅ„, abyÅ› wzbiÅ‚ siÄ™ na jeszcze wyÅ¼szy poziom! GotÃ³w na wyzwanie?</p>
                </div>
                <div id="geminiTrainingPlan" class="gemini-response-card hidden min-h-[150px]">
                    <p class="text-center text-gray-500">Kliknij przycisk, aby Bielik wygenerowaÅ‚ TwÃ³j plan!</p>
                </div>
                <button class="button-cartoon button-gemini mt-6 py-3 px-6 w-full text-lg" onclick="generateTrainingPlan()">
                    âœ¨ Generuj MÃ³j Orli Plan Treningowy! 
                    <span id="loadingTrainingPlan" class="loading-spinner hidden"></span>
                </button>
            </div>
        </section>

    </main>

    <footer class="py-8 bg-gray-800 text-center border-t-4 bielik-red-border">
        <div class="container mx-auto px-6">
            <p class="text-gray-300 text-sm">&copy; <span id="currentYearV7_dashboard"></span> Perun AI. Wszelkie prawa zastrzeÅ¼one przez Naczelnego Bielika i jego Super-DruÅ¼ynÄ™ AnalitykÃ³w.</p>
            <p class="text-gray-400 text-xs mt-1">Analizujemy, byÅ› Ty mÃ³gÅ‚ lataÄ‡... po torze! ğŸğŸ¦…ğŸ‰</p>
        </div>
    </footer>

    <script>
        // Aktualizacja roku w stopce
        document.getElementById('currentYearV7_dashboard').textContent = new Date().getFullYear();

        // Dane do wykresÃ³w (przykÅ‚adowe)
        const lapTimeData = {
            labels: ['Sesja 1', 'Sesja 2', 'Sesja 3', 'Sesja 4', 'Sesja 5', 'Sesja 6', 'Sesja 7', 'Sesja 8', 'Sesja 9', 'Sesja 10'],
            datasets: [{
                label: 'Najlepszy Czas OkrÄ…Å¼enia (s)',
                data: [65.2, 64.8, 64.9, 64.5, 63.8, 63.9, 63.5, 63.2, 63.3, 62.8],
                borderColor: '#3B82F6', 
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.1,
                fill: true,
                borderWidth: 2
            }]
        };
        // ... (reszta danych wykresÃ³w bez zmian) ...
        const sectorImprovementData = {
            labels: ['Sektor 1', 'Sektor 2', 'Sektor 3'],
            datasets: [
                {
                    label: 'Åšr. Czas - Pierwsze 5 Sesji (s)',
                    data: [22.5, 20.8, 21.5],
                    backgroundColor: '#FBBF24', 
                    borderColor: '#F59E0B',
                    borderWidth: 1
                },
                {
                    label: 'Åšr. Czas - Ostatnie 5 Sesji (s)',
                    data: [22.1, 19.9, 21.2],
                    backgroundColor: '#10B981', 
                    borderColor: '#059669',
                    borderWidth: 1
                }
            ]
        };
        
        const lastSessionLapsData = {
            labels: ['Okr. 1', 'Okr. 2', 'Okr. 3', 'Okr. 4', 'Okr. 5', 'Okr. 6', 'Okr. 7', 'Okr. 8', 'Okr. 9', 'Okr. 10'],
            datasets: [{
                label: 'Czas OkrÄ…Å¼enia (s)',
                data: [65.1, 64.5, 63.8, 63.5, 63.112, 63.3, 63.4, 63.2, 64.0, 63.6],
                borderColor: '#EF4444', 
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.1,
                fill: true,
                borderWidth: 2
            }]
        };

        const speedProfileData = {
            labels: Array.from({length: 15}, (_, i) => `${i*100}m`), 
            datasets: [
                {
                    label: 'Twoja PrÄ™dkoÅ›Ä‡ (km/h)',
                    data: [0, 30, 55, 70, 65, 50, 40, 60, 75, 80, 70, 55, 45, 65, 0],
                    borderColor: '#3B82F6', 
                    tension: 0.2,
                    borderWidth: 3,
                    pointRadius: 0,
                },
                {
                    label: 'Benchmark Bielika (km/h)',
                    data: [0, 32, 58, 72, 68, 53, 42, 63, 78, 82, 73, 58, 48, 68, 0],
                    borderColor: '#F59E0B', 
                    borderDash: [5, 5],
                    tension: 0.2,
                    borderWidth: 2,
                    pointRadius: 0,
                }
            ]
        };


        // Inicjalizacja wykresÃ³w
        window.onload = function() {
            const ctxLapTime = document.getElementById('lapTimeEvolutionChart')?.getContext('2d');
            if (ctxLapTime) new Chart(ctxLapTime, { type: 'line', data: lapTimeData, options: { responsive: true, maintainAspectRatio: false } });

            const ctxSectorImprovement = document.getElementById('sectorImprovementChart')?.getContext('2d');
            if (ctxSectorImprovement) new Chart(ctxSectorImprovement, { type: 'bar', data: sectorImprovementData, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true }} } });
            
            const ctxLastSessionLaps = document.getElementById('lastSessionLapsChart')?.getContext('2d');
            if (ctxLastSessionLaps) new Chart(ctxLastSessionLaps, { type: 'line', data: lastSessionLapsData, options: { responsive: true, maintainAspectRatio: false } });

            const ctxSpeedProfile = document.getElementById('speedProfileChart')?.getContext('2d');
            if (ctxSpeedProfile) new Chart(ctxSpeedProfile, { type: 'line', data: speedProfileData, options: { responsive: true, maintainAspectRatio: false, elements: { line: { fill: false } } } });
        };

        // Funkcje Gemini API
        const apiKey = ""; // Klucz API - pozostaw pusty, Canvas dostarczy go w runtime

        async function callGeminiAPI(prompt) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("BÅ‚Ä…d API:", response.status, errorData);
                    return `Przepraszam, Super-Bielik ma chwilowÄ… czkawkÄ™ i nie moÅ¼e teraz odpowiedzieÄ‡ (BÅ‚Ä…d: ${response.status}). SprÃ³buj za moment!`;
                }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Nieoczekiwana struktura odpowiedzi:", result);
                    return "Hmm, Super-Bielik zgubiÅ‚ gdzieÅ› swoje mÄ…dre sÅ‚owa. SprÃ³buj jeszcze raz!";
                }
            } catch (error) {
                console.error("BÅ‚Ä…d poÅ‚Ä…czenia z API Gemini:", error);
                return "Ojej! WyglÄ…da na to, Å¼e goÅ‚Ä…b pocztowy z mojÄ… odpowiedziÄ… zgubiÅ‚ siÄ™ w chmurach. SprawdÅº poÅ‚Ä…czenie i sprÃ³buj ponownie!";
            }
        }

        async function getGeminiAdvice(adviceType) {
            let promptContext = "";
            let responseElementId = "";
            let loadingElementId = "";
            const userName = document.getElementById('userName')?.textContent || "Kierowco";

            if (adviceType === 'lapTimeEvolution') {
                const lapTimes = lapTimeData.datasets[0].data.join(', ');
                const currentComment = document.getElementById('lapTimeEvolutionComment')?.innerText || "Twoje czasy okrÄ…Å¼eÅ„ ewoluujÄ….";
                promptContext = `Jestem amatorem kartingu, ${userName}. Moje ostatnie 10 najlepszych czasÃ³w okrÄ…Å¼eÅ„ to: ${lapTimes} sekund. MÃ³j obecny komentarz od trenera Bielika brzmi: "${currentComment}".`;
                responseElementId = 'geminiAdviceLapTime';
                loadingElementId = 'loadingLapTime';
                document.getElementById(loadingElementId).classList.remove('hidden');
                const prompt = `${promptContext} Jako Super-Bielik, mÃ³j jeszcze mÄ…drzejszy trener AI, podpowiedz mi w zabawny i motywujÄ…cy sposÃ³b, na czym powinienem siÄ™ teraz skupiÄ‡, aby dalej poprawiaÄ‡ swoje czasy? Daj mi 2-3 konkretne, krÃ³tkie wskazÃ³wki. PamiÄ™taj o swoim orlim stylu! Odpowiedz po polsku.`;
                const advice = await callGeminiAPI(prompt);
                const responseCard = document.getElementById(responseElementId);
                responseCard.innerHTML = `<p class="text-sm text-gray-700"><strong class="font-fredoka">Super-Bielik Radzi:</strong> ${advice.replace(/\n/g, '<br>')}</p>`;
                responseCard.classList.remove('hidden');
                document.getElementById(loadingElementId).classList.add('hidden');

            } else if (adviceType === 'mainGoal') {
                const currentGoalComment = document.getElementById('mainGoalComment')?.innerText || "Masz cel dotyczÄ…cy punktu hamowania.";
                promptContext = `Jestem amatorem kartingu, ${userName}. MÃ³j obecny gÅ‚Ã³wny cel od trenera Bielika to: "${currentGoalComment}".`;
                responseElementId = 'geminiAdviceMainGoal';
                loadingElementId = 'loadingMainGoal';
                document.getElementById(loadingElementId).classList.remove('hidden');
                const prompt = `${promptContext} Jako Super-Bielik, mÃ³j super-inteligentny trener AI, rozwiÅ„ tÄ™ poradÄ™. Daj mi jednÄ… dodatkowÄ…, kreatywnÄ… wskazÃ³wkÄ™ lub Ä‡wiczenie, ktÃ³re pomoÅ¼e mi zrealizowaÄ‡ ten cel. Utrzymaj zabawny, orli ton! Odpowiedz po polsku.`;
                const advice = await callGeminiAPI(prompt);
                const responseCard = document.getElementById(responseElementId);
                responseCard.innerHTML = `<p class="text-sm text-gray-700"><strong class="font-fredoka">Super-Bielik Precyzuje:</strong> ${advice.replace(/\n/g, '<br>')}</p>`;
                responseCard.classList.remove('hidden');
                document.getElementById(loadingElementId).classList.add('hidden');
            }
        }

        async function generateTrainingPlan() {
            const loadingElement = document.getElementById('loadingTrainingPlan');
            const responseElement = document.getElementById('geminiTrainingPlan');
            const userName = document.getElementById('userName')?.textContent || "Drogi Kierowco";
            const bestLap = document.getElementById('bestLapTime')?.textContent || "nieznany";
            const lastSession = document.getElementById('lastSessionTime')?.textContent || "nieznana";
            const sectorImprovementComment = document.getElementById('sectorImprovementComment')?.innerText || "brak danych o sektorach";
            const mainGoalComment = document.getElementById('mainGoalComment')?.innerText || "brak gÅ‚Ã³wnego celu";

            loadingElement.classList.remove('hidden');
            responseElement.innerHTML = `<p class="text-center text-gray-500">GeneraÅ‚ Bielik juÅ¼ kombinuje TwÃ³j plan... To wymaga skupienia!</p>`;
            responseElement.classList.remove('hidden');

            const prompt = `Jako GeneraÅ‚ Bielik, najwyÅ¼szy rangÄ… trener AI dla kierowcy kartingowego o imieniu ${userName}, przygotuj spersonalizowany, tygodniowy plan treningowy. 
            Oto podsumowanie jego ostatnich osiÄ…gniÄ™Ä‡:
            - Najlepszy czas okrÄ…Å¼enia: ${bestLap}
            - Czas ostatniej sesji: ${lastSession}
            - Komentarz dotyczÄ…cy poprawy w sektorach: "${sectorImprovementComment}"
            - GÅ‚Ã³wny cel od trenera Bielika: "${mainGoalComment}"

            Plan powinien byÄ‡ zabawny, motywujÄ…cy i zawieraÄ‡:
            1.  GÅ‚Ã³wny cel na ten tydzieÅ„ (1 zdanie).
            2.  Trzy kluczowe obszary do poprawy (np. technika hamowania, pÅ‚ynnoÅ›Ä‡ w szykanach, koncentracja).
            3.  Propozycje 2-3 konkretnych Ä‡wiczeÅ„ lub zadaÅ„ na torze (jeÅ›li to moÅ¼liwe) lub mentalnych do wykonania w tygodniu.
            4.  KrÃ³tkÄ…, orlÄ… poradÄ™ motywacyjnÄ… na koniec.
            PamiÄ™taj o swoim generalskim, ale wciÄ…Å¼ zabawnym i kreskÃ³wkowym stylu! Odpowiedz po polsku, uÅ¼ywajÄ…c formatowania markdown (np. nagÅ‚Ã³wki, listy).`;

            const plan = await callGeminiAPI(prompt);
            // Proste parsowanie markdown do HTML (moÅ¼na rozbudowaÄ‡)
            let htmlPlan = plan.replace(/\n\n/g, '<br><br>').replace(/\n/g, '<br>');
            htmlPlan = htmlPlan.replace(/### (.*?)<br>/g, '<h3><strong>$1</strong></h3>');
            htmlPlan = htmlPlan.replace(/## (.*?)<br>/g, '<h2><strong>$1</strong></h2>');
            htmlPlan = htmlPlan.replace(/\* (.*?)<br>/g, '<li>$1</li>');
            htmlPlan = htmlPlan.replace(/<br><li>/g, '<li>'); // Poprawka dla list
             if (htmlPlan.includes('<li>')) {
                htmlPlan = '<ul>' + htmlPlan.replace(/<li>(.*?)<\/li>/g, '<li class="list-disc ml-5">$1</li>') + '</ul>';
                htmlPlan = htmlPlan.replace(/<\/li><br><ul>/g, '</li></ul><br><ul>'); // Poprawka dla wielokrotnych list
            }


            responseElement.innerHTML = `<div class="text-sm text-gray-700">${htmlPlan}</div>`;
            loadingElement.classList.add('hidden');
        }

    </script>
</body>
</html>
